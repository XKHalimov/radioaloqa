<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radioaloqa Signal Analizatori</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 2px solid #3b82f6;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 32px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mode-selector {
            text-align: center;
            max-width: 800px;
            margin: 100px auto;
        }

        .mode-selector h1 {
            justify-content: center;
            margin-bottom: 20px;
        }

        .mode-options {
            display: grid;
            gap: 20px;
            margin-top: 40px;
        }

        .mode-option {
            background: rgba(51, 65, 85, 0.8);
            padding: 30px;
            border-radius: 12px;
            border-left: 4px solid;
            transition: all 0.3s;
        }

        .mode-option.server {
            border-color: #10b981;
        }

        .mode-option.client {
            border-color: #3b82f6;
        }

        .mode-option h3 {
            font-size: 24px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-option p {
            color: #cbd5e1;
            margin-bottom: 16px;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        button:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #4b5563;
            cursor: not-allowed;
            opacity: 0.6;
        }

        button.success {
            background: #10b981;
        }

        button.success:hover:not(:disabled) {
            background: #059669;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover:not(:disabled) {
            background: #dc2626;
        }

        button.warning {
            background: #f97316;
        }

        button.warning:hover:not(:disabled) {
            background: #ea580c;
        }

        input {
            width: 100%;
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid #3b82f6;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            margin-bottom: 16px;
        }

        input:focus {
            outline: none;
            border-color: #60a5fa;
        }

        .status-box {
            background: rgba(51, 65, 85, 0.8);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-connected {
            border: 2px solid #10b981;
        }

        .status-disconnected {
            border: 2px solid #ef4444;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-box {
            background: rgba(51, 65, 85, 0.8);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .stat-label {
            font-size: 14px;
            color: #cbd5e1;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .connection-id {
            background: rgba(15, 23, 42, 0.9);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #10b981;
            margin-bottom: 20px;
        }

        .connection-id-label {
            font-size: 14px;
            color: #10b981;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .connection-id-value {
            font-size: 24px;
            font-family: 'Courier New', monospace;
            color: #22c55e;
            word-break: break-all;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            margin-left: 10px;
        }

        .info-box {
            background: rgba(202, 138, 4, 0.2);
            border: 2px solid #ca8a04;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-box h4 {
            color: #fbbf24;
            margin-bottom: 12px;
        }

        .info-box ol {
            color: #cbd5e1;
            padding-left: 20px;
        }

        .info-box li {
            margin-bottom: 8px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mode Selection Screen -->
        <div id="modeSelector" class="mode-selector">
            <div class="card">
                <h1>
                    <span>üì°</span>
                    Radioaloqa Signal Analizatori
                </h1>
                <p style="color: #cbd5e1; margin-top: 16px;">
                    Ikkita kompyuter o'rtasida audio aloqa va signal tahlili
                </p>

                <div class="mode-options">
                    <div class="mode-option server">
                        <h3>
                            <span>üñ•Ô∏è</span>
                            Server rejimi (1-kompyuter)
                        </h3>
                        <p>Bu kompyuterni server qiling. Boshqa kompyuter sizga ulanadi.</p>
                        <button onclick="startAsServer()" class="success">Server sifatida boshlash</button>
                    </div>

                    <div class="mode-option client">
                        <h3>
                            <span>üíª</span>
                            Client rejimi (2-kompyuter)
                        </h3>
                        <p>Server kompyuterga ulanish uchun uning ID raqamini kiriting.</p>
                        <input type="text" id="serverIdInput" placeholder="Server ID ni kiriting (masalan: ABC-123-XYZ)">
                        <button onclick="startAsClient()" class="success">Serverga ulanish</button>
                    </div>
                </div>

                <div class="info-box">
                    <h4>üìù Yo'riqnoma:</h4>
                    <ol>
                        <li>Ikkala kompyuter bitta WiFi tarmog'ida bo'lishi SHART EMAS</li>
                        <li>1-kompyuterni "Server" rejimida ishga tushiring</li>
                        <li>Server ID raqamini ko'ring va 2-kompyuterga yuboring</li>
                        <li>2-kompyuterda server ID ni kiriting va ulaning</li>
                        <li>Har ikki tarafda "Gapirish" tugmasini bosing va muloqot qiling!</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Main Application Screen -->
        <div id="mainApp" class="hidden">
            <div class="card">
                <div class="header">
                    <h1>
                        <span>üì°</span>
                        <span id="modeTitle">Signal Analizatori</span>
                    </h1>
                    <button onclick="disconnect()" class="danger" style="width: auto; padding: 12px 24px;">Chiqish</button>
                </div>

                <!-- Connection ID Display (Only for Server) -->
                <div id="serverIdDisplay" class="connection-id hidden">
                    <div class="connection-id-label">üìå Sizning Server ID raqamingiz:</div>
                    <div class="connection-id-value">
                        <span id="serverId"></span>
                        <button onclick="copyServerId()" class="copy-btn success">Nusxalash</button>
                    </div>
                    <p style="color: #cbd5e1; margin-top: 12px; font-size: 14px;">
                        ‚ö†Ô∏è Bu ID ni ikkinchi kompyuterga yuboring
                    </p>
                </div>

                <!-- Status Box -->
                <div id="statusBox" class="status-box status-disconnected">
                    <span id="statusIcon">‚ùå</span>
                    <span id="statusText">Ulanish kutilmoqda...</span>
                </div>

                <!-- Control Buttons -->
                <div class="grid-2">
                    <button id="startBtn" onclick="startTransmission()" class="success" disabled>
                        üé§ Gapirish
                    </button>
                    <button id="stopBtn" onclick="stopTransmission()" class="warning" disabled>
                        üîá To'xtatish
                    </button>
                </div>
            </div>

            <!-- Statistics -->
            <div id="statsContainer" class="hidden">
                <div class="grid-2">
                    <!-- My Signal Stats -->
                    <div class="card" style="border-color: #10b981;">
                        <h2 style="color: #10b981; margin-bottom: 16px;">üì§ Sizning signalingiz</h2>
                        <div class="grid-4">
                            <div class="stat-box" style="border-color: #3b82f6;">
                                <div class="stat-label">Chastota</div>
                                <div class="stat-value" style="color: white;" id="myFreq">0 Hz</div>
                            </div>
                            <div class="stat-box" style="border-color: #10b981;">
                                <div class="stat-label">Signal</div>
                                <div class="stat-value" id="mySignal">0 dB</div>
                            </div>
                            <div class="stat-box" style="border-color: #f59e0b;">
                                <div class="stat-label">Shovqin</div>
                                <div class="stat-value" style="color: white;" id="myNoise">0</div>
                            </div>
                            <div class="stat-box" style="border-color: #8b5cf6;">
                                <div class="stat-label">SNR</div>
                                <div class="stat-value" style="color: white;" id="mySNR">0 dB</div>
                            </div>
                        </div>
                    </div>

                    <!-- Remote Signal Stats -->
                    <div class="card" style="border-color: #3b82f6;">
                        <h2 style="color: #3b82f6; margin-bottom: 16px;">üì• Qarshi tomondan</h2>
                        <div class="grid-4">
                            <div class="stat-box" style="border-color: #3b82f6;">
                                <div class="stat-label">Chastota</div>
                                <div class="stat-value" style="color: white;" id="remoteFreq">0 Hz</div>
                            </div>
                            <div class="stat-box" style="border-color: #10b981;">
                                <div class="stat-label">Signal</div>
                                <div class="stat-value" id="remoteSignal">0 dB</div>
                            </div>
                            <div class="stat-box" style="border-color: #3b82f6; grid-column: span 2;">
                                <div class="stat-label">Holat</div>
                                <div class="stat-value" style="color: #64748b;" id="remoteStatus">üîá Tinch</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid-2">
                    <div class="card" style="border-color: #3b82f6;">
                        <h2 style="color: #3b82f6; margin-bottom: 16px;">Chastota Spektri</h2>
                        <div class="chart-container">
                            <canvas id="frequencyChart"></canvas>
                        </div>
                    </div>

                    <div class="card" style="border-color: #10b981;">
                        <h2 style="color: #10b981; margin-bottom: 16px;">Signal Tarixi</h2>
                        <div class="chart-container">
                            <canvas id="signalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="remoteAudio" autoplay></audio>

    <script>
        // Global variables
        let mode = null;
        let peerId = null;
        let serverId = null;
        let isConnected = false;
        let isTransmitting = false;
        let remoteTransmitting = false;
        
        let audioContext = null;
        let analyser = null;
        let micStream = null;
        let peerConnection = null;
        let dataChannel = null;
        let animationFrame = null;

        let frequencyChart = null;
        let signalChart = null;
        let signalHistory = [];

        // Generate unique ID
        function generateId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let id = '';
            for (let i = 0; i < 3; i++) {
                if (i > 0) id += '-';
                for (let j = 0; j < 3; j++) {
                    id += chars.charAt(Math.floor(Math.random() * chars.length));
                }
            }
            return id;
        }

        // Start as Server
        function startAsServer() {
            mode = 'server';
            serverId = generateId();
            
            document.getElementById('modeSelector').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('modeTitle').textContent = 'Server Rejimi';
            
            document.getElementById('serverIdDisplay').classList.remove('hidden');
            document.getElementById('serverId').textContent = serverId;
            
            updateStatus('üü°', 'Client kutilmoqda...');
            
            setupWebRTC();
            initCharts();
            
            // Simulate client connection after 3 seconds (for demo)
            setTimeout(() => {
                simulateConnection();
            }, 3000);
        }

        // Start as Client
        function startAsClient() {
            const serverIdInput = document.getElementById('serverIdInput').value.trim();
            
            if (!serverIdInput) {
                alert('‚ö†Ô∏è Iltimos, Server ID ni kiriting!');
                return;
            }
            
            mode = 'client';
            peerId = generateId();
            serverId = serverIdInput;
            
            document.getElementById('modeSelector').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('modeTitle').textContent = 'Client Rejimi';
            
            updateStatus('üü°', 'Serverga ulanilmoqda...');
            
            setupWebRTC();
            initCharts();
            
            // Simulate connection
            setTimeout(() => {
                simulateConnection();
            }, 2000);
        }

        // Simulate Connection (for demo purposes)
        function simulateConnection() {
            isConnected = true;
            updateStatus('‚úÖ', mode === 'server' ? 'Client ulandi!' : 'Serverga ulandi!');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('statsContainer').classList.remove('hidden');
        }

        // Setup WebRTC
        function setupWebRTC() {
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(config);
            
            if (mode === 'server') {
                dataChannel = peerConnection.createDataChannel('signalData');
                setupDataChannel();
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
            }
            
            peerConnection.ontrack = (event) => {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
            };
        }

        // Setup Data Channel
        function setupDataChannel() {
            dataChannel.onopen = () => {
                console.log('Data channel opened');
            };
            
            dataChannel.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleRemoteData(data);
            };
        }

        // Handle Remote Data
        function handleRemoteData(data) {
            if (data.type === 'signal') {
                document.getElementById('remoteFreq').textContent = data.frequency + ' Hz';
                document.getElementById('remoteSignal').textContent = data.signalStrength.toFixed(1) + ' dB';
                document.getElementById('remoteSignal').style.color = getSignalColor(data.signalStrength);
                
                remoteTransmitting = data.isTransmitting;
                document.getElementById('remoteStatus').textContent = data.isTransmitting ? 'üé§ Gapirmoqda' : 'üîá Tinch';
                document.getElementById('remoteStatus').style.color = data.isTransmitting ? '#10b981' : '#64748b';
            }
        }

        // Send Signal Data
        function sendSignalData(data) {
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify(data));
            }
        }

        // Start Transmission
        async function startTransmission() {
            if (!isConnected) {
                alert('‚ö†Ô∏è Avval ulanish o\'rnating!');
                return;
            }

            try {
                micStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                
                const source = audioContext.createMediaStreamSource(micStream);
                source.connect(analyser);
                
                if (peerConnection) {
                    micStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, micStream);
                    });
                }
                
                isTransmitting = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                analyzeAudio();
            } catch (err) {
                console.error('Mikrofon xatosi:', err);
                alert('‚ùå Mikrofondan foydalanishda xato yuz berdi!');
            }
        }

        // Stop Transmission
        function stopTransmission() {
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
            }
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            
            isTransmitting = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            sendSignalData({
                type: 'signal',
                isTransmitting: false,
                frequency: 0,
                signalStrength: 0
            });
        }

        // Analyze Audio
        function analyzeAudio() {
            if (!analyser || !isTransmitting) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const timeData = new Uint8Array(bufferLength);
            
            analyser.getByteFrequencyData(dataArray);
            analyser.getByteTimeDomainData(timeData);

            // Calculate RMS
            let sum = 0;
            for (let i = 0; i < timeData.length; i++) {
                const normalized = (timeData[i] - 128) / 128;
                sum += normalized * normalized;
            }
            const rms = Math.sqrt(sum / timeData.length);
            const dbValue = 20 * Math.log10(rms + 0.0001);
            const normalizedDb = Math.max(0, Math.min(100, (dbValue + 60) * 1.67));

            // Find dominant frequency
            let maxVal = 0;
            let maxIndex = 0;
            for (let i = 0; i < dataArray.length; i++) {
                if (dataArray[i] > maxVal) {
                    maxVal = dataArray[i];
                    maxIndex = i;
                }
            }
            
            const nyquist = audioContext.sampleRate / 2;
            const dominantFreq = (maxIndex * nyquist) / bufferLength;

            // Calculate noise floor
            const sortedData = Array.from(dataArray).sort((a, b) => a - b);
            const noiseFloor = sortedData.slice(0, Math.floor(sortedData.length * 0.1))
                .reduce((a, b) => a + b, 0) / (sortedData.length * 0.1);

            // Calculate SNR
            const snrValue = maxVal > 0 ? 20 * Math.log10(maxVal / (noiseFloor + 1)) : 0;

            // Update UI
            document.getElementById('myFreq').textContent = Math.round(dominantFreq) + ' Hz';
            document.getElementById('mySignal').textContent = normalizedDb.toFixed(1) + ' dB';
            document.getElementById('mySignal').style.color = getSignalColor(normalizedDb);
            document.getElementById('myNoise').textContent = Math.round(noiseFloor);
            document.getElementById('mySNR').textContent = Math.round(snrValue) + ' dB';

            // Update charts
            updateFrequencyChart(dataArray, nyquist, bufferLength);
            updateSignalChart(normalizedDb, snrValue);

            // Send to remote
            sendSignalData({
                type: 'signal',
                isTransmitting: true,
                frequency: Math.round(dominantFreq),
                signalStrength: normalizedDb
            });

            animationFrame = requestAnimationFrame(analyzeAudio);
        }

        // Get Signal Color
        function getSignalColor(strength) {
            if (strength > 70) return '#10b981';
            if (strength > 40) return '#f59e0b';
            return '#ef4444';
        }

        // Update Status
        function updateStatus(icon, text) {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusText').textContent = text;
            
            const statusBox = document.getElementById('statusBox');
            if (icon === '‚úÖ') {
                statusBox.classList.remove('status-disconnected');
                statusBox.classList.add('status-connected');
            } else {
                statusBox.classList.remove('status-connected');
                statusBox.classList.add('status-disconnected');
            }
        }

        // Copy Server ID
        function copyServerId() {
            const id = document.getElementById('serverId').textContent;
            navigator.clipboard.writeText(id).then(() => {
                alert('‚úÖ Server ID nusxalandi: ' + id);
            });
        }

        // Disconnect
        function disconnect() {
            stopTransmission();
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            isConnected = false;
            mode = null;
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('modeSelector').classList.remove('hidden');
            document.getElementById('serverIdDisplay').classList.add('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
        }

        // Initialize Charts
        function initCharts() {
            const freqCtx = document.getElementById('frequencyChart').getContext('2d');
            frequencyChart = new Chart(freqCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Amplituda',
                        data: [],
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            const signalCtx = document.getElementById('signalChart').getContext('2d');
            signalChart = new Chart(signalCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Signal',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'SNR',
                            data: [],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        // Update Frequency Chart
        function updateFrequencyChart(dataArray, nyquist, bufferLength) {
            const labels = [];
            const data = [];
            const step = Math.floor(bufferLength / 50);
            
            for (let i = 0; i < 50; i++) {
                const index = i * step;
                const freq = (index * nyquist) / bufferLength;
                labels.push(Math.round(freq));
                data.push(dataArray[index]);
            }
            
            frequencyChart.data.labels = labels;
            frequencyChart.data.datasets[0].data = data;
            frequencyChart.update('none');
        }

        // Update Signal Chart
        function updateSignalChart(signal, snr) {
            const now = new Date().toLocaleTimeString();
            
            signalHistory.push({ time: now, signal, snr });
            if (signalHistory.length > 50) signalHistory.shift();
            
            signalChart.data.labels = signalHistory.map(h => h.time);
            signalChart.data.datasets[0].data = signalHistory.map(h => h.signal);
            signalChart.data.datasets[1].data = signalHistory.map(h => h.snr);
            signalChart.update('none');
        }
    </script>
</body>
</html>