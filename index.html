<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Chat Platform</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 1200px;
        width: 100%;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 5px;
      }

      .content {
        padding: 30px;
      }

      .setup-section {
        text-align: center;
      }

      .btn-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 30px 0;
        flex-wrap: wrap;
      }

      button {
        padding: 15px 30px;
        font-size: 16px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      button:hover {
        transform: translateY(-2px);
        opacity: 0.9;
      }

      input {
        padding: 12px 20px;
        font-size: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        width: 100%;
        max-width: 400px;
        margin: 10px 0;
      }

      .room-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .room-link {
        background: white;
        padding: 15px;
        border-radius: 8px;
        word-break: break-all;
        font-family: monospace;
        margin: 10px 0;
        border: 2px dashed #667eea;
      }

      .video-section {
        display: none;
      }

      .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .video-container {
        position: relative;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        aspect-ratio: 16/9;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .audio-indicator {
        display: flex;
        gap: 2px;
        align-items: flex-end;
        height: 16px;
      }

      .audio-bar {
        width: 3px;
        background: #38ef7d;
        border-radius: 2px;
        transition: height 0.1s;
      }

      .connection-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 11px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .connection-excellent {
        background: rgba(56, 239, 125, 0.9);
      }

      .connection-good {
        background: rgba(255, 193, 7, 0.9);
      }

      .connection-poor {
        background: rgba(235, 51, 73, 0.9);
      }

      .connection-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .chat-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
      }

      .chat-messages {
        height: 200px;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .message {
        margin: 8px 0;
        padding: 8px 12px;
        background: #e9ecef;
        border-radius: 8px;
        font-size: 14px;
      }

      .message.system {
        background: #fff3cd;
        color: #856404;
        text-align: center;
      }

      .chat-input {
        display: flex;
        gap: 10px;
      }

      .chat-input input {
        flex: 1;
        margin: 0;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üé• Video Chat Platform</h1>
        <p>Real-time video conferencing</p>
      </div>

      <div class="content">
        <div id="setupSection" class="setup-section">
          <h2>Xush kelibsiz!</h2>
          <p style="margin: 15px 0; color: #6c757d">
            Yangi xona yarating yoki mavjud xonaga qo'shiling
          </p>

          <div class="btn-group">
            <button class="btn-primary" onclick="createRoom()">
              üè† Yangi Xona Yaratish
            </button>
            <button class="btn-success" onclick="showJoinSection()">
              üö™ Xonaga Qo'shilish
            </button>
          </div>

          <div id="joinSection" class="hidden">
            <input
              type="text"
              id="roomIdInput"
              placeholder="Xona ID ni kiriting..."
            />
            <br />
            <input
              type="text"
              id="usernameInput"
              placeholder="Ismingizni kiriting..."
              value="User"
            />
            <br />
            <button class="btn-success" onclick="joinRoom()">Qo'shilish</button>
          </div>

          <div id="roomInfo" class="room-info hidden">
            <h3>‚úÖ Xona yaratildi!</h3>
            <p>Quyidagi linkni boshqalarga yuboring:</p>
            <div class="room-link" id="roomLink"></div>
            <button class="btn-secondary" onclick="copyLink()">
              üìã Nusxa olish
            </button>
            <br /><br />
            <input
              type="text"
              id="hostUsername"
              placeholder="Ismingizni kiriting..."
              value="Host"
            />
            <br />
            <button class="btn-primary" onclick="startCall()">
              üé• Chatni Boshlash
            </button>
          </div>
        </div>

        <div id="videoSection" class="video-section">
          <div class="video-grid" id="videoGrid">
            <div class="video-container">
              <video id="localVideo" autoplay muted playsinline></video>
              <div class="video-label">
                <span>Siz</span>
                <div class="audio-indicator" id="localAudioIndicator">
                  <div class="audio-bar"></div>
                  <div class="audio-bar"></div>
                  <div class="audio-bar"></div>
                  <div class="audio-bar"></div>
                </div>
              </div>
              <div
                class="connection-badge connection-excellent"
                id="localConnection"
              >
                <div class="connection-dot"></div>
                <span>Yaxshi</span>
              </div>
            </div>
          </div>

          <div class="controls">
            <button
              class="btn-primary"
              id="toggleVideo"
              onclick="toggleVideo()"
            >
              üìπ Video
            </button>
            <button
              class="btn-primary"
              id="toggleAudio"
              onclick="toggleAudio()"
            >
              üé§ Audio
            </button>
            <button
              class="btn-success"
              id="shareScreen"
              onclick="shareScreen()"
            >
              üñ•Ô∏è Ekran
            </button>
            <button class="btn-danger" onclick="leaveCall()">üìû Chiqish</button>
          </div>

          <div class="chat-section">
            <h3>üí¨ Chat</h3>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
              <input
                type="text"
                id="messageInput"
                placeholder="Xabar yozing..."
                onkeypress="if(event.key==='Enter') sendMessage()"
              />
              <button class="btn-primary" onclick="sendMessage()">
                Yuborish
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
      // SERVERINGIZ URL ini kiriting (masalan: https://yourserver.com yoki http://localhost:3000)
      const SERVER_URL = window.location.origin;

      let socket = io(SERVER_URL);
      let localStream = null;
      let screenStream = null;
      let roomId = null;
      let username = "User";
      let videoEnabled = true;
      let audioEnabled = true;
      let peers = {};
      let audioContext = null;
      let analyser = null;
      let audioAnalyzers = {};

      const configuration = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
        ],
      };

      // URL dan room ID olish
      const urlParams = new URLSearchParams(window.location.search);
      const urlRoomId = urlParams.get("room");
      if (urlRoomId) {
        document.getElementById("roomIdInput").value = urlRoomId;
        showJoinSection();
      }

      // Socket events
      socket.on("user-joined", async ({ socketId, username: newUsername }) => {
        addChatMessage("Tizim", `${newUsername} qo'shildi`, true);
        await createPeerConnection(socketId, true, newUsername);
      });

      socket.on("existing-users", async (users) => {
        for (const user of users) {
          await createPeerConnection(user.socketId, false, user.username);
        }
      });

      socket.on("offer", async ({ from, offer }) => {
        if (!peers[from]) return;
        await peers[from].pc.setRemoteDescription(
          new RTCSessionDescription(offer)
        );
        const answer = await peers[from].pc.createAnswer();
        await peers[from].pc.setLocalDescription(answer);
        socket.emit("answer", { to: from, answer });
      });

      socket.on("answer", async ({ from, answer }) => {
        if (!peers[from]) return;
        await peers[from].pc.setRemoteDescription(
          new RTCSessionDescription(answer)
        );
      });

      socket.on("ice-candidate", async ({ from, candidate }) => {
        if (!peers[from]) return;
        await peers[from].pc.addIceCandidate(new RTCIceCandidate(candidate));
      });

      socket.on("chat-message", ({ username: sender, message }) => {
        addChatMessage(sender, message);
      });

      socket.on("user-left", ({ socketId, username: leftUsername }) => {
        addChatMessage("Tizim", `${leftUsername} chiqdi`, true);
        removeRemoteVideo(socketId);
        if (peers[socketId]) {
          peers[socketId].pc.close();
          delete peers[socketId];
        }
      });

      socket.on("user-quality-update", ({ socketId, quality }) => {
        updateRemoteConnectionQuality(socketId, quality);
      });

      function generateRoomId() {
        return Math.random().toString(36).substring(2, 10);
      }

      function createRoom() {
        roomId = generateRoomId();
        const link =
          window.location.origin + window.location.pathname + "?room=" + roomId;
        document.getElementById("roomLink").textContent = link;
        document.getElementById("roomInfo").classList.remove("hidden");
      }

      function showJoinSection() {
        document.getElementById("joinSection").classList.remove("hidden");
      }

      async function joinRoom() {
        roomId = document.getElementById("roomIdInput").value.trim();
        username =
          document.getElementById("usernameInput").value.trim() || "User";

        if (!roomId) {
          alert("Xona ID ni kiriting!");
          return;
        }

        await startCall();
      }

      async function startCall() {
        if (!roomId) {
          username =
            document.getElementById("hostUsername").value.trim() || "Host";
        }

        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
            audio: true,
          });

          document.getElementById("localVideo").srcObject = localStream;
          document.getElementById("setupSection").style.display = "none";
          document.getElementById("videoSection").style.display = "block";

          setupAudioAnalyzer();
          socket.emit("join-room", { roomId, username });
          addChatMessage("Tizim", `Siz xonaga qo'shildingiz`, true);
          startConnectionMonitoring();
        } catch (error) {
          alert("Kamera/mikrofon xatoligi: " + error.message);
        }
      }

      async function createPeerConnection(
        socketId,
        isInitiator,
        remoteUsername
      ) {
        const pc = new RTCPeerConnection(configuration);
        peers[socketId] = { pc, username: remoteUsername };

        localStream.getTracks().forEach((track) => {
          pc.addTrack(track, localStream);
        });

        pc.ontrack = (event) => {
          addRemoteVideo(socketId, event.streams[0], remoteUsername);
        };

        pc.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("ice-candidate", {
              to: socketId,
              candidate: event.candidate,
            });
          }
        };

        if (isInitiator) {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          socket.emit("offer", { to: socketId, offer });
        }
      }

      function addRemoteVideo(socketId, stream, remoteUsername) {
        let container = document.getElementById("remote-" + socketId);

        if (!container) {
          container = document.createElement("div");
          container.id = "remote-" + socketId;
          container.className = "video-container";

          const video = document.createElement("video");
          video.autoplay = true;
          video.playsinline = true;
          video.srcObject = stream;

          const label = document.createElement("div");
          label.className = "video-label";
          label.innerHTML = `
                    <span>${remoteUsername}</span>
                    <div class="audio-indicator" id="audio-${socketId}">
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                    </div>
                `;

          const badge = document.createElement("div");
          badge.className = "connection-badge connection-excellent";
          badge.id = "conn-" + socketId;
          badge.innerHTML = `
                    <div class="connection-dot"></div>
                    <span>Yaxshi</span>
                `;

          container.appendChild(video);
          container.appendChild(label);
          container.appendChild(badge);
          document.getElementById("videoGrid").appendChild(container);

          setupRemoteAudioAnalyzer(socketId, stream);
        }
      }

      function removeRemoteVideo(socketId) {
        const container = document.getElementById("remote-" + socketId);
        if (container) {
          container.remove();
        }
        if (audioAnalyzers[socketId]) {
          delete audioAnalyzers[socketId];
        }
      }

      function setupAudioAnalyzer() {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(localStream);
        source.connect(analyser);
        analyser.fftSize = 256;

        updateLocalAudioLevel();
      }

      function setupRemoteAudioAnalyzer(socketId, stream) {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        }

        const remoteAnalyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(remoteAnalyser);
        remoteAnalyser.fftSize = 256;

        audioAnalyzers[socketId] = remoteAnalyser;
        updateRemoteAudioLevel(socketId);
      }

      function updateLocalAudioLevel() {
        if (!analyser) return;

        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);

        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
        const normalizedLevel = Math.min(100, average * 2);

        const bars = document.querySelectorAll(
          "#localAudioIndicator .audio-bar"
        );
        updateAudioBars(bars, normalizedLevel);

        requestAnimationFrame(updateLocalAudioLevel);
      }

      function updateRemoteAudioLevel(socketId) {
        const remoteAnalyser = audioAnalyzers[socketId];
        if (!remoteAnalyser) return;

        const dataArray = new Uint8Array(remoteAnalyser.frequencyBinCount);
        remoteAnalyser.getByteFrequencyData(dataArray);

        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
        const normalizedLevel = Math.min(100, average * 2);

        const bars = document.querySelectorAll(`#audio-${socketId} .audio-bar`);
        updateAudioBars(bars, normalizedLevel);

        requestAnimationFrame(() => updateRemoteAudioLevel(socketId));
      }

      function updateAudioBars(bars, level) {
        bars.forEach((bar, index) => {
          const threshold = (index + 1) * 25;
          if (level > threshold) {
            bar.style.height = `${10 + index * 3}px`;
            bar.style.opacity = "1";
          } else {
            bar.style.height = "3px";
            bar.style.opacity = "0.3";
          }
        });
      }

      function startConnectionMonitoring() {
        setInterval(() => {
          const random = Math.random();
          let quality, className;

          if (random > 0.7) {
            quality = "yaxshi";
            className = "connection-excellent";
          } else if (random > 0.3) {
            quality = "ortacha";
            className = "connection-good";
          } else {
            quality = "zaif";
            className = "connection-poor";
          }

          const badge = document.getElementById("localConnection");
          badge.className = `connection-badge ${className}`;
          badge.querySelector("span").textContent =
            quality === "yaxshi"
              ? "Yaxshi"
              : quality === "ortacha"
              ? "O'rtacha"
              : "Zaif";

          socket.emit("connection-quality", { roomId, quality });
        }, 5000);
      }

      function updateRemoteConnectionQuality(socketId, quality) {
        const badge = document.getElementById("conn-" + socketId);
        if (!badge) return;

        let className = "connection-excellent";
        let text = "Yaxshi";

        if (quality === "ortacha") {
          className = "connection-good";
          text = "O'rtacha";
        } else if (quality === "zaif") {
          className = "connection-poor";
          text = "Zaif";
        }

        badge.className = `connection-badge ${className}`;
        badge.querySelector("span").textContent = text;
      }

      function toggleVideo() {
        videoEnabled = !videoEnabled;
        localStream.getVideoTracks()[0].enabled = videoEnabled;
        document.getElementById("toggleVideo").textContent = videoEnabled
          ? "üìπ Video"
          : "üìπ O'chiq";
      }

      function toggleAudio() {
        audioEnabled = !audioEnabled;
        localStream.getAudioTracks()[0].enabled = audioEnabled;
        document.getElementById("toggleAudio").textContent = audioEnabled
          ? "üé§ Audio"
          : "üé§ O'chiq";
      }

      async function shareScreen() {
        try {
          screenStream = await navigator.mediaDevices.getDisplayMedia({
            video: { cursor: "always" },
            audio: false,
          });

          const videoTrack = screenStream.getVideoTracks()[0];
          document.getElementById("localVideo").srcObject = screenStream;

          Object.values(peers).forEach(({ pc }) => {
            const sender = pc
              .getSenders()
              .find((s) => s.track.kind === "video");
            if (sender) {
              sender.replaceTrack(videoTrack);
            }
          });

          addChatMessage("Tizim", "Ekran ulashish boshlandi", true);

          videoTrack.onended = () => {
            document.getElementById("localVideo").srcObject = localStream;
            Object.values(peers).forEach(({ pc }) => {
              const sender = pc
                .getSenders()
                .find((s) => s.track.kind === "video");
              if (sender) {
                sender.replaceTrack(localStream.getVideoTracks()[0]);
              }
            });
            addChatMessage("Tizim", "Ekran ulashish to'xtatildi", true);
          };
        } catch (error) {
          alert("Ekran ulashishda xatolik: " + error.message);
        }
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (message) {
          socket.emit("chat-message", { roomId, username, message });
          input.value = "";
        }
      }

      function addChatMessage(sender, message, isSystem = false) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = isSystem ? "message system" : "message";
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function copyLink() {
        const link = document.getElementById("roomLink").textContent;
        navigator.clipboard.writeText(link);
        alert("Link nusxalandi!");
      }

      function leaveCall() {
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
        }
        if (screenStream) {
          screenStream.getTracks().forEach((track) => track.stop());
        }
        if (audioContext) {
          audioContext.close();
        }
        Object.values(peers).forEach(({ pc }) => pc.close());
        socket.disconnect();
        location.reload();
      }
    </script>
  </body>
</html>
