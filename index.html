<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Chat Platform</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 1200px;
        width: 100%;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 5px;
      }

      .header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .content {
        padding: 30px;
      }

      .setup-section {
        text-align: center;
      }

      .btn-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 30px 0;
        flex-wrap: wrap;
      }

      button {
        padding: 15px 30px;
        font-size: 16px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(56, 239, 125, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      input {
        padding: 12px 20px;
        font-size: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        width: 100%;
        max-width: 400px;
        margin: 10px 0;
        transition: border 0.3s;
      }

      input:focus {
        outline: none;
        border-color: #667eea;
      }

      .room-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .room-link {
        background: white;
        padding: 15px;
        border-radius: 8px;
        word-break: break-all;
        font-family: monospace;
        margin: 10px 0;
        border: 2px dashed #667eea;
      }

      .video-section {
        display: none;
      }

      .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .video-container {
        position: relative;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        aspect-ratio: 16/9;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .audio-indicator {
        display: flex;
        gap: 2px;
        align-items: flex-end;
        height: 20px;
      }

      .audio-bar {
        width: 3px;
        background: #38ef7d;
        border-radius: 2px;
        transition: height 0.1s;
      }

      .connection-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 11px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .connection-excellent {
        background: rgba(56, 239, 125, 0.9);
        color: white;
      }

      .connection-good {
        background: rgba(255, 193, 7, 0.9);
        color: white;
      }

      .connection-poor {
        background: rgba(235, 51, 73, 0.9);
        color: white;
      }

      .connection-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .chat-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
      }

      .chat-messages {
        height: 200px;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .message {
        margin: 8px 0;
        padding: 8px 12px;
        background: #e9ecef;
        border-radius: 8px;
        font-size: 14px;
      }

      .message.own {
        background: #667eea;
        color: white;
        margin-left: 20%;
      }

      .chat-input {
        display: flex;
        gap: 10px;
      }

      .chat-input input {
        flex: 1;
        margin: 0;
      }

      .participants {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
      }

      .participants h3 {
        margin-bottom: 10px;
        color: #667eea;
      }

      .participant {
        background: white;
        padding: 10px;
        border-radius: 5px;
        margin: 5px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #38ef7d;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üé• Video Chat Platform</h1>
        <p>Real-time video conferencing va ekran ulashish</p>
      </div>

      <div class="content">
        <div id="setupSection" class="setup-section">
          <h2>Xush kelibsiz!</h2>
          <p style="margin: 15px 0; color: #6c757d">
            Yangi xona yarating yoki mavjud xonaga qo'shiling
          </p>

          <div class="btn-group">
            <button class="btn-primary" onclick="createRoom()">
              üè† Yangi Xona Yaratish
            </button>
            <button class="btn-success" onclick="showJoinSection()">
              üö™ Xonaga Qo'shilish
            </button>
          </div>

          <div id="joinSection" class="hidden">
            <input
              type="text"
              id="roomIdInput"
              placeholder="Xona ID ni kiriting..."
            />
            <br />
            <input
              type="text"
              id="usernameInput"
              placeholder="Ismingizni kiriting..."
              value="User"
            />
            <br />
            <button class="btn-success" onclick="joinRoom()">Qo'shilish</button>
          </div>

          <div id="roomInfo" class="room-info hidden">
            <h3>‚úÖ Xona yaratildi!</h3>
            <p>Quyidagi linkni boshqalarga yuboring:</p>
            <div class="room-link" id="roomLink"></div>
            <button class="btn-secondary" onclick="copyLink()">
              üìã Nusxa olish
            </button>
            <br /><br />
            <input
              type="text"
              id="hostUsername"
              placeholder="Ismingizni kiriting..."
              value="Host"
            />
            <br />
            <button class="btn-primary" onclick="startCall()">
              üé• Chatni Boshlash
            </button>
          </div>
        </div>

        <div id="videoSection" class="video-section">
          <div class="participants">
            <h3>üë• Ishtirokchilar (<span id="participantCount">0</span>)</h3>
            <div id="participantsList"></div>
          </div>

          <div class="video-grid" id="videoGrid">
            <div class="video-container">
              <video id="localVideo" autoplay muted playsinline></video>
              <div class="video-label">
                <span>Siz</span>
                <div class="audio-indicator" id="localAudioIndicator">
                  <div class="audio-bar"></div>
                  <div class="audio-bar"></div>
                  <div class="audio-bar"></div>
                  <div class="audio-bar"></div>
                </div>
              </div>
              <div
                class="connection-badge connection-excellent"
                id="localConnection"
              >
                <div class="connection-dot"></div>
                <span>Yaxshi</span>
              </div>
            </div>
          </div>

          <div class="controls">
            <button
              class="btn-primary"
              id="toggleVideo"
              onclick="toggleVideo()"
            >
              üìπ Video
            </button>
            <button
              class="btn-primary"
              id="toggleAudio"
              onclick="toggleAudio()"
            >
              üé§ Audio
            </button>
            <button
              class="btn-success"
              id="shareScreen"
              onclick="shareScreen()"
            >
              üñ•Ô∏è Ekran Ulashish
            </button>
            <button class="btn-danger" onclick="leaveCall()">üìû Chiqish</button>
          </div>

          <div class="chat-section">
            <h3>üí¨ Chat</h3>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
              <input
                type="text"
                id="messageInput"
                placeholder="Xabar yozing..."
                onkeypress="if(event.key==='Enter') sendMessage()"
              />
              <button class="btn-primary" onclick="sendMessage()">
                Yuborish
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let localStream = null;
      let screenStream = null;
      let roomId = null;
      let username = "User";
      let videoEnabled = true;
      let audioEnabled = true;
      let participants = new Map();
      let audioContext = null;
      let analyser = null;

      const urlParams = new URLSearchParams(window.location.search);
      const urlRoomId = urlParams.get("room");
      if (urlRoomId) {
        document.getElementById("roomIdInput").value = urlRoomId;
        showJoinSection();
      }

      function generateRoomId() {
        return Math.random().toString(36).substring(2, 10);
      }

      function createRoom() {
        roomId = generateRoomId();
        const link =
          window.location.origin + window.location.pathname + "?room=" + roomId;
        document.getElementById("roomLink").textContent = link;
        document.getElementById("roomInfo").classList.remove("hidden");

        addChatMessage("Tizim", "Xona yaratildi! Linkni ulashing.");
      }

      function showJoinSection() {
        document.getElementById("joinSection").classList.remove("hidden");
      }

      async function joinRoom() {
        roomId = document.getElementById("roomIdInput").value.trim();
        username =
          document.getElementById("usernameInput").value.trim() || "User";

        if (!roomId) {
          alert("Xona ID ni kiriting!");
          return;
        }

        await startCall();
      }

      async function startCall() {
        if (!roomId) {
          username =
            document.getElementById("hostUsername").value.trim() || "Host";
        }

        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
            audio: true,
          });

          document.getElementById("localVideo").srcObject = localStream;
          document.getElementById("setupSection").style.display = "none";
          document.getElementById("videoSection").style.display = "block";

          setupAudioAnalyzer();
          addParticipant(username, true);
          addChatMessage("Tizim", `${username} xonaga qo'shildi`);

          startConnectionMonitoring();
        } catch (error) {
          alert("Kamera yoki mikrofonga kirishda xatolik: " + error.message);
        }
      }

      function setupAudioAnalyzer() {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(localStream);
        source.connect(analyser);
        analyser.fftSize = 256;

        updateAudioLevel();
      }

      function updateAudioLevel() {
        if (!analyser) return;

        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);

        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
        const normalizedLevel = Math.min(100, average * 2);

        const bars = document.querySelectorAll(
          "#localAudioIndicator .audio-bar"
        );
        bars.forEach((bar, index) => {
          const threshold = (index + 1) * 25;
          if (normalizedLevel > threshold) {
            bar.style.height = `${10 + index * 3}px`;
            bar.style.opacity = "1";
          } else {
            bar.style.height = "3px";
            bar.style.opacity = "0.3";
          }
        });

        requestAnimationFrame(updateAudioLevel);
      }

      function startConnectionMonitoring() {
        setInterval(() => {
          const random = Math.random();
          let quality, className;

          if (random > 0.7) {
            quality = "Yaxshi";
            className = "connection-excellent";
          } else if (random > 0.3) {
            quality = "O'rtacha";
            className = "connection-good";
          } else {
            quality = "Zaif";
            className = "connection-poor";
          }

          const badge = document.getElementById("localConnection");
          badge.className = `connection-badge ${className}`;
          badge.querySelector("span").textContent = quality;
        }, 3000);
      }

      function addParticipant(name, isLocal) {
        participants.set(name, { name, isLocal });
        updateParticipantsList();
      }

      function updateParticipantsList() {
        const list = document.getElementById("participantsList");
        list.innerHTML = "";
        participants.forEach((participant, name) => {
          const div = document.createElement("div");
          div.className = "participant";
          div.innerHTML = `
                    <span class="status-dot"></span>
                    <span>${name}${participant.isLocal ? " (Siz)" : ""}</span>
                `;
          list.appendChild(div);
        });
        document.getElementById("participantCount").textContent =
          participants.size;
      }

      function toggleVideo() {
        videoEnabled = !videoEnabled;
        localStream.getVideoTracks()[0].enabled = videoEnabled;
        document.getElementById("toggleVideo").textContent = videoEnabled
          ? "üìπ Video"
          : "üìπ Video (O'chiq)";
      }

      function toggleAudio() {
        audioEnabled = !audioEnabled;
        localStream.getAudioTracks()[0].enabled = audioEnabled;
        document.getElementById("toggleAudio").textContent = audioEnabled
          ? "üé§ Audio"
          : "üé§ Audio (O'chiq)";
      }

      async function shareScreen() {
        try {
          screenStream = await navigator.mediaDevices.getDisplayMedia({
            video: { cursor: "always" },
            audio: false,
          });

          const videoTrack = screenStream.getVideoTracks()[0];
          document.getElementById("localVideo").srcObject = screenStream;
          addChatMessage("Tizim", "Ekran ulashish boshlandi");

          videoTrack.onended = () => {
            document.getElementById("localVideo").srcObject = localStream;
            addChatMessage("Tizim", "Ekran ulashish to'xtatildi");
          };
        } catch (error) {
          alert("Ekran ulashishda xatolik: " + error.message);
        }
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (message) {
          addChatMessage(username, message, true);
          input.value = "";
        }
      }

      function addChatMessage(sender, message, isOwn = false) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message" + (isOwn ? " own" : "");
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function copyLink() {
        const link = document.getElementById("roomLink").textContent;
        navigator.clipboard.writeText(link);
        alert("Link nusxalandi!");
      }

      function leaveCall() {
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
        }
        if (screenStream) {
          screenStream.getTracks().forEach((track) => track.stop());
        }
        if (audioContext) {
          audioContext.close();
        }
        location.reload();
      }
    </script>
  </body>
</html>
